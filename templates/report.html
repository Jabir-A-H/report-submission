{% extends 'base.html' %}
{% set page_title = 'জোন রিপোর্ট (এক নজরে)' %}
{% block content %}
<div class="container mx-auto px-4 py-8 animate-fade-in">
  <div class="text-center mb-8">
    <h1 class="text-4xl font-extrabold text-cyan-700 mb-2 text-center">
      জোন রিপোর্ট (এক নজরে)
    </h1>
    {% if not request.args.get('report_id') or (current_user and current_user.role != 'admin') %}
    <form method="get" class="flex flex-wrap gap-2 justify-center mb-4" id="report-filter-form">
      <select id="report-type-select" name="report_type" class="p-2 border border-gray-300 rounded-lg">
        <option value="মাসিক" {% if report_type == 'মাসিক' %}selected{% endif %}>মাসিক</option>
        <option value="ত্রৈমাসিক" {% if report_type == 'ত্রৈমাসিক' %}selected{% endif %}>ত্রৈমাসিক</option>
        <option value="ষান্মাসিক" {% if report_type == 'ষান্মাসিক' %}selected{% endif %}>ষান্মাসিক</option>
        <option value="নয়-মাসিক" {% if report_type == 'নয়-মাসিক' %}selected{% endif %}>নয়-মাসিক</option>
        <option value="বার্ষিক" {% if report_type == 'বার্ষিক' %}selected{% endif %}>বার্ষিক</option>
      </select>
      <select id="month-select" name="month" class="p-2 border border-gray-300 rounded-lg">
        {% for i in range(1, 13) %}
        <option value="{{ i }}" {% if i == month|int %}selected{% endif %}>{{ i|month_name }}</option>
        {% endfor %}
      </select>
      <select name="year" class="p-2 border border-gray-300 rounded-lg">
        {% for y in range(2025, 2027) %}
        <option value="{{ y }}" {% if y == year|int %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 transition">সার্চ করুন</button>
    </form>
      <div class="relative">
        <button type="button" id="downloadDropdownBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition shadow">
          ডাউনলোড
        </button>
        <div id="downloadDropdown" class="hidden absolute left-0 mt-2 w-32 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
          <a href="/download_report?report_type={{ report_type }}&month={{ month }}&year={{ year }}&format=pdf" class="block px-4 py-2 text-gray-700 hover:bg-purple-50">PDF</a>
          <a href="/download_report?report_type={{ report_type }}&month={{ month }}&year={{ year }}&format=excel" class="block px-4 py-2 text-gray-700 hover:bg-green-50">Excel</a>
        </div>
      </div>
    {% endif %}
  </div>
  <div class="flex flex-col gap-8">
    <!-- Header Table (fields from header.html, read-only) -->
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-cyan-400">
      <h2 class="text-xl font-bold text-cyan-700 mb-2">মূল তথ্য</h2>
      {% if report.header %}
        <div class="grid grid-cols-2 gap-4 text-gray-700 text-sm">
          <div><span class="font-semibold">দায়িত্বশীলের নাম:</span> {{ report.header.responsible_name }}</div>
          <div><span class="font-semibold">থানা:</span> {{ report.header.thana }}</div>
          <div><span class="font-semibold">ওয়ার্ড:</span> {{ report.header.ward }}</div>
          <div><span class="font-semibold">মোট মুয়াল্লিমা সংখ্যা:</span> {{ report.header.total_muallima }}</div>
          <div><span class="font-semibold">মুয়াল্লিমা বৃদ্ধি:</span> {{ report.header.muallima_increase }}</div>
          <div><span class="font-semibold">মুয়াল্লিমা হ্রাস:</span> {{ report.header.muallima_decrease }}</div>
          <div><span class="font-semibold">প্রশিক্ষিত মুয়াল্লিমা:</span> {{ report.header.certified_muallima }}</div>
          <div><span class="font-semibold">প্রশিক্ষিত মুয়াল্লিমা (ক্লাস নিচ্ছেন):</span> {{ report.header.certified_muallima_taking_classes }}</div>
          <div><span class="font-semibold">ট্রেইনিং প্রাপ্ত মুয়াল্লিমা:</span> {{ report.header.trained_muallima }}</div>
          <div><span class="font-semibold">ট্রেইনিং প্রাপ্ত মুয়াল্লিমা (ক্লাস নিচ্ছেন):</span> {{ report.header.trained_muallima_taking_classes }}</div>
          <div><span class="font-semibold">মোট ইউনিট:</span> {{ report.header.total_unit }}</div>
          <div><span class="font-semibold">মুয়াল্লিমা সহ ইউনিট:</span> {{ report.header.units_with_muallima }}</div>
        </div>
      {% else %}
        <div class="text-red-500">Header section incomplete.</div>
      {% endif %}
    </div>
    <!-- Courses Table (from courses.html, read-only) -->
    <div class="bg-gradient-to-br from-purple-50 to-white rounded-xl shadow-lg p-6 border-l-4 border-purple-400">
      <h2 class="text-xl font-bold text-purple-700 mb-4">গ্রুপ / কোর্স রিপোর্ট</h2>
      {% if report.courses and course_categories and cat_to_slug %}
        <div class="overflow-x-auto w-full">
          <table class="min-w-full border border-gray-300 bg-white rounded-lg text-xs md:text-sm">
            <thead>
              <tr class="bg-cyan-100 text-gray-900 text-center">
                <th rowspan="2" class="border border-gray-300 px-2 py-2 align-middle sticky left-0 z-10 bg-white">বিভাগ/ধরন</th>
                <th colspan="3" class="border border-gray-300 px-2 py-2">গ্রুপ / কোর্স</th>
                <th rowspan="2" class="border border-gray-300 px-2 py-2 align-middle">অধিবেশন সংখ্যা</th>
                <th rowspan="2" class="border border-gray-300 px-2 py-2 align-middle">শিক্ষার্থী সংখ্যা</th>
                <th rowspan="2" class="border border-gray-300 px-2 py-2 align-middle">উপস্থিতি সংখ্যা</th>
                <th colspan="4" class="border border-gray-300 px-2 py-2">শিক্ষার্থী অবস্থান</th>
                <th rowspan="2" class="border border-gray-300 px-2 py-2 align-middle">কতজন নিয়ে সমাপ্ত</th>
                <th rowspan="2" class="border border-gray-300 px-2 py-2 align-middle">সহীহ শিখেছেন কতজন</th>
              </tr>
              <tr class="bg-cyan-50 text-gray-800 text-center">
                <th class="border border-gray-300 px-2 py-1">সংখ্যা</th>
                <th class="border border-gray-300 px-2 py-1">বৃদ্ধি</th>
                <th class="border border-gray-300 px-2 py-1">ঘাটতি</th>
                <th class="border border-gray-300 px-2 py-1">বোর্ডে</th>
                <th class="border border-gray-300 px-2 py-1">কায়দায়</th>
                <th class="border border-gray-300 px-2 py-1">আমপারা</th>
                <th class="border border-gray-300 px-2 py-1">কুরআন</th>
              </tr>
            </thead>
            <tbody>
              {% for category in course_categories %}
                {% set slug = cat_to_slug[category] %}
                {% set row = report.courses|selectattr('category', 'equalto', category)|first if report and report.courses else None %}
                <tr class="text-center hover:bg-cyan-50">
                  <td class="border border-gray-300 px-2 py-1 font-semibold sticky left-0 z-10 bg-white">{{ category }}</td>
                  {% set fields = [
                    'number', 'increase', 'decrease', 'sessions', 'students', 'attendance',
                    'status_board', 'status_qayda', 'status_ampara', 'status_quran',
                    'completed', 'correctly_learned'] %}
                  {% for field in fields %}
                    <td class="border border-gray-300 px-2 py-1">
                      {{ row[field] if row and row[field] is not none else 0 }}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-red-500">কোর্স রিপোর্ট তথ্য পাওয়া যায়নি।</div>
      {% endif %}
    </div>
    <!-- Organizational Table -->
    <div class="bg-gradient-to-br from-cyan-50 to-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-cyan-700 mb-4">সংগঠন</h2>
      {% if report.organizational %}
        <table class="min-w-full text-sm border rounded-xl overflow-hidden">
          <thead class="bg-cyan-100 text-cyan-800">
            <tr><th class="px-3 py-2">ক্যাটাগরি</th><th class="px-3 py-2">সংখ্যা</th></tr>
          </thead>
          <tbody>
            {% for org in report.organizational %}
            <tr class="hover:bg-cyan-50">
              <td class="px-3 py-2">{{ org.category }}</td>
              <td class="px-3 py-2 text-center">{{ org.number }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>
    <!-- Personal Table -->
    <div class="bg-gradient-to-br from-pink-50 to-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-pink-700 mb-4">ব্যক্তিগত</h2>
      {% if report.personal %}
        <table class="min-w-full text-sm border rounded-xl overflow-hidden">
          <thead class="bg-pink-100 text-pink-800">
            <tr><th class="px-3 py-2">ক্যাটাগরি</th><th class="px-3 py-2">Teaching</th><th class="px-3 py-2">Learning</th></tr>
          </thead>
          <tbody>
            {% for p in report.personal %}
            <tr class="hover:bg-pink-50">
              <td class="px-3 py-2">{{ p.category }}</td>
              <td class="px-3 py-2 text-center">{{ p.teaching }}</td>
              <td class="px-3 py-2 text-center">{{ p.learning }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>
    <!-- Meetings Table -->
    <div class="bg-gradient-to-br from-blue-50 to-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-blue-700 mb-4">বৈঠকসমূহ</h2>
      {% if report.meetings %}
        <table class="min-w-full text-sm border rounded-xl overflow-hidden">
          <thead class="bg-blue-100 text-blue-800">
            <tr><th class="px-3 py-2">ক্যাটাগরি</th><th class="px-3 py-2">City Count</th></tr>
          </thead>
          <tbody>
            {% for m in report.meetings %}
            <tr class="hover:bg-blue-50">
              <td class="px-3 py-2">{{ m.category }}</td>
              <td class="px-3 py-2 text-center">{{ m.city_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>
    <!-- Extras Table -->
    <div class="bg-gradient-to-br from-green-50 to-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-green-700 mb-4">এক্সট্রা</h2>
      {% if report.extras %}
        <table class="min-w-full text-sm border rounded-xl overflow-hidden">
          <thead class="bg-green-100 text-green-800">
            <tr><th class="px-3 py-2">ক্যাটাগরি</th><th class="px-3 py-2">সংখ্যা</th></tr>
          </thead>
          <tbody>
            {% for e in report.extras %}
            <tr class="hover:bg-green-50">
              <td class="px-3 py-2">{{ e.category }}</td>
              <td class="px-3 py-2 text-center">{{ e.number }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>
    <!-- Comments Table -->
    <div class="bg-gradient-to-br from-yellow-50 to-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-yellow-700 mb-4">মন্তব্য</h2>
      {% if report.comments %}
        <div class="text-gray-700 text-sm">{{ report.comments.comment }}</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
